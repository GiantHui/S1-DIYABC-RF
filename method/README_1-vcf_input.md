# Y染色体VCF转DIYABC-RF格式脚本说明

## 脚本概述

脚本 `1-vcf_input.py` 用于将Y染色体VCF文件转换为DIYABC-RF分析软件所需的IndSeq SNP TXT格式。

## 处理流程详解

### 1. 输入文件配置

#### 1.1 VCF文件
- **路径**: `/mnt/d/Sex_biased_project/7049_sexbi.indel.lowq.het.dp2.mis0.05.mM2.format.vcf.gz`
- **格式**: 压缩的VCF格式 (.vcf.gz)
- **内容**: Y染色体变异位点数据，包含基因型信息

#### 1.2 样本族群对照表
- **路径**: `/mnt/f/OneDrive/科研/4_代码/DIYABC-RF/conf/1_random_sampled.txt`
- **格式**: 制表符分隔，两列数据，无表头
  - 第一列：样本ID (如: 111-1539-5899)
  - 第二列：族群ID (如: Han_Henan)
- **样本数**: 60个目标样本

### 2. 数据提取与筛选逻辑

#### 2.1 样本筛选
```python
# 读取族群表，提取目标样本列表
pop_df = pd.read_csv(pop_table, sep=r"\s+", header=None, names=["ID", "POP"])
target_samples = pop_df.ID.tolist()  # 提取60个目标样本ID
pop_map = dict(zip(pop_df.ID, pop_df.POP))  # 创建样本-族群映射字典

# 在VCF中仅保留目标样本
vcf.set_samples(target_samples)
```

#### 2.2 变异位点筛选条件
脚本对每个VCF记录应用以下筛选条件：

1. **染色体筛选**
   ```python
   if var.CHROM not in ("Y", "chrY"):
       continue  # 仅保留Y染色体位点
   ```

2. **等位基因数量筛选**
   ```python
   if len(var.ALT) != 1:
       continue  # 仅保留双等位基因位点（1个REF + 1个ALT）
   ```

3. **多态性筛选**
   ```python
   alleles = set(gt[0] for gt in var.genotypes if gt[0] != -1)
   if len(alleles) < 2:
       continue  # 确保在目标样本中REF和ALT至少各出现一次
   ```

### 3. 基因型编码转换

#### 3.1 VCF基因型格式
- Y染色体为单倍型数据
- 每个基因型为列表：`[allele, phase_info]`
- `allele`: 0=REF, 1=ALT, -1=缺失

#### 3.2 DIYABC编码转换规则
```python
for idx, gt in enumerate(var.genotypes):
    a1 = gt[0]  # 提取等位基因值
    g = 9       # 默认为缺失值
    if a1 != -1:
        g = 1 if a1 == 0 else 0  # REF->1, ALT->0
    geno_dict[samples[idx]].append(str(g))
```

**编码对应关系**:
- `REF等位基因 (0)` → `1`
- `ALT等位基因 (1)` → `0`  
- `缺失数据 (-1)` → `9`

### 4. 输出格式构建

#### 4.1 DIYABC-RF文件结构

**第1行 - 标题行**:
```
<NM=1.0NF> <MAF=hudson>  Y-SNP data generated by script
```
- `<NM=1.0NF>`: 性别比例参数 (雄性/雌性=1:1)
- `<MAF=hudson>`: 最小等位基因频率计算方法

**第2行 - 列标题**:
```
IND SEX POP Y Y Y Y... (4910个Y)
```
- `IND`: 样本ID列
- `SEX`: 性别列 (Y染色体样本全为M)
- `POP`: 族群列
- `Y Y Y...`: 位点列，数量等于筛选后的SNP数量

**第3-62行 - 样本数据**:
```
样本ID 性别 族群 基因型1 基因型2 基因型3 ...
111-1539-5899 M Han_Henan 1 1 1 1 0 1 1 1 ...
```

#### 4.2 数据完整性
- **样本数**: 60个 (根据族群对照表)
- **位点数**: 4910个 (经筛选的多态Y-SNP)
- **基因型数据**: 每个样本4910个位点的编码值

### 5. 质量控制要点

#### 5.1 数据验证
- 确保所有目标样本在VCF中存在
- 验证提取的位点确实为多态位点
- 检查基因型编码的正确性

#### 5.2 输出验证
- 文件行数: 62行 (1行标题 + 1行列名 + 60行样本数据)
- 每行位点数: 与筛选出的SNP数量一致
- 编码值范围: 仅包含0、1、9

### 6. 脚本运行结果

**成功运行示例**:
```bash
[INFO] 目标样本 60 个，将从 VCF 中提取…
[INFO] 采集到 4910 个多态位点，写入 /path/to/output/TB.txt
[DONE] DIYABC 输入文件已生成。
```

### 7. 故障排除

#### 7.1 常见问题
1. **cyvcf2版本兼容性**: 不同版本API可能有差异
2. **样本不匹配**: 族群表中的样本在VCF中不存在
3. **内存不足**: 大型VCF文件可能导致内存问题

#### 7.2 依赖库版本
- pandas: 数据处理
- cyvcf2: VCF文件读取 (注意版本兼容性)
- pathlib: 路径处理

### 8. 文件路径配置

所有路径在脚本USER CONFIG区域集中配置：
- **输入VCF**: 包含Y染色体变异数据的VCF文件
- **族群对照表**: 定义目标样本及其族群归属
- **输出文件**: DIYABC-RF格式的分析输入文件
- **参数设置**: 性别比例和MAF计算方法

---

**注意**: 此脚本专门用于Y染色体单倍型数据的处理，不适用于常染色体双倍型数据。